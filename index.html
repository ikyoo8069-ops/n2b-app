<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N2B 정부지원사업 매칭 v3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl font-bold">🚀 N2B 정부지원사업 매칭</h1>
            <p class="text-purple-100 mt-1">v3.2 - 실시간 API 연동 (기업마당 + K-Startup)</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- API Key -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">🔑 Anthropic API Key</label>
            <input type="password" id="apiKey" class="w-full px-4 py-3 border rounded-lg" placeholder="sk-ant-api...">
            <p class="text-xs text-gray-500 mt-1">API 키는 <a href="https://console.anthropic.com" target="_blank" class="text-purple-600 underline">Anthropic Console</a>에서 발급받을 수 있습니다.</p>
        </div>

        <!-- Region -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">📍 지역 선택</label>
            <select id="regionSelect" class="w-full px-4 py-3 border rounded-lg bg-white">
                <option value="전체">🇰🇷 전체 (전국)</option>
                <option value="서울">서울특별시</option>
                <option value="부산">부산광역시</option>
                <option value="대구">대구광역시</option>
                <option value="인천">인천광역시</option>
                <option value="광주">광주광역시</option>
                <option value="대전">대전광역시</option>
                <option value="울산">울산광역시</option>
                <option value="세종">세종특별자치시</option>
                <option value="경기">경기도</option>
                <option value="강원">강원특별자치도</option>
                <option value="충북">충청북도</option>
                <option value="충남">충청남도</option>
                <option value="전북">전북특별자치도</option>
                <option value="전남">전라남도</option>
                <option value="경북">경상북도</option>
                <option value="경남">경상남도</option>
                <option value="제주">제주특별자치도</option>
            </select>
        </div>

        <!-- 사업계획 입력 -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">📝 사업계획 입력</label>
            <p class="text-xs text-gray-500 mb-2">샘플을 선택하거나 직접 입력하세요:</p>
            <div class="flex flex-wrap gap-2 mb-3">
                <button onclick="loadSample('health')" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">🏥 AI 헬스케어</button>
                <button onclick="loadSample('farm')" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">🌱 스마트팜</button>
                <button onclick="loadSample('recycle')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">♻️ 폐플라스틱 재활용</button>
            </div>
            <textarea id="proposalText" rows="5" class="w-full px-4 py-3 border rounded-lg" placeholder="사업 아이디어를 입력하세요..."></textarea>
        </div>

        <!-- 버튼 -->
        <div class="flex gap-4 mb-6">
            <button onclick="analyzeN2B()" class="flex-1 gradient-bg text-white py-4 rounded-xl font-bold">1️⃣ N2B 분석</button>
            <button onclick="matchPrograms()" id="matchBtn" disabled class="flex-1 bg-gray-400 text-white py-4 rounded-xl font-bold disabled:opacity-50">2️⃣ 지원사업 매칭</button>
        </div>

        <!-- 로딩 -->
        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
            <p class="mt-4 text-gray-600" id="loadingText">분석 중...</p>
        </div>

        <!-- N2B 결과 -->
        <div id="n2bResult" class="hidden bg-white rounded-xl shadow-md p-4 mb-4">
            <h2 class="text-lg font-bold text-gray-800 mb-4">📊 N2B 분석 결과</h2>
            <div class="space-y-3">
                <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                    <h3 class="font-bold text-red-700 text-sm">N (Not) - 문제점</h3>
                    <p id="resultN" class="text-gray-700 text-sm mt-1"></p>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                    <h3 class="font-bold text-blue-700 text-sm">B (But) - 솔루션</h3>
                    <p id="resultB" class="text-gray-700 text-sm mt-1"></p>
                </div>
                <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                    <h3 class="font-bold text-green-700 text-sm">B (Because) - 근거</h3>
                    <p id="resultC" class="text-gray-700 text-sm mt-1"></p>
                </div>
                <div class="bg-purple-50 p-3 rounded">
                    <h3 class="font-bold text-purple-700 text-sm">🏷️ 키워드</h3>
                    <div id="resultKeywords" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>
        </div>

        <!-- 매칭 결과 -->
        <div id="matchResult" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800">🎯 매칭된 지원사업</h2>
                <div class="flex gap-2">
                    <span id="totalCount" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm"></span>
                    <span id="regionBadge" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm"></span>
                </div>
            </div>
            <div id="programList" class="space-y-4"></div>
        </div>
    </main>

    <script>
        let n2bAnalysis = null;
        const API_BASE = 'https://n2b-backend.onrender.com';

        const samples = {
            health: '저는 웨어러블 디바이스와 AI를 결합하여 실시간 건강 모니터링 및 만성질환 예측 서비스를 개발합니다. 고령화 사회에서 개인 맞춤형 건강관리 솔루션을 제공합니다.',
            farm: '저는 IoT 센서와 AI를 결합하여 토양, 기후, 작물 상태를 실시간 모니터링하고 최적의 재배 환경을 자동 제어하는 스마트팜 솔루션을 개발합니다.',
            recycle: 'AI 기반 폐플라스틱 자동 분류 시스템을 개발하여 재활용률을 높이고 환경오염을 줄이는 솔루션을 제공합니다.'
        };

        function loadSample(key) {
            document.getElementById('proposalText').value = samples[key] || '';
        }

        async function analyzeN2B() {
            const apiKey = document.getElementById('apiKey').value;
            const proposalText = document.getElementById('proposalText').value;

            if (!apiKey) { alert('API Key를 입력해주세요.'); return; }
            if (!proposalText) { alert('사업계획서를 입력해주세요.'); return; }

            showLoading(true, '🔍 N2B 분석 중...');

            try {
                const response = await fetch(`${API_BASE}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, proposalText })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || '분석 실패');
                }

                // 결과 파싱
                let parsed = {};
                if (data.result) {
                    try {
                        // JSON 문자열에서 파싱
                        const jsonMatch = data.result.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            parsed = JSON.parse(jsonMatch[0]);
                        }
                    } catch (e) {
                        console.log('Parse error:', e);
                    }
                }

                n2bAnalysis = {
                    not: parsed.not || data.N || '분석 결과 없음',
                    but: parsed.but || data.B || '분석 결과 없음',
                    because: parsed.because || data.C || '분석 결과 없음'
                };

                document.getElementById('resultN').textContent = n2bAnalysis.not;
                document.getElementById('resultB').textContent = n2bAnalysis.but;
                document.getElementById('resultC').textContent = n2bAnalysis.because;

                const keywordsDiv = document.getElementById('resultKeywords');
                const keywords = parsed.keywords || data.keywords || [];
                if (keywords.length > 0) {
                    keywordsDiv.innerHTML = keywords.map(k => 
                        `<span class="px-3 py-1 bg-purple-200 text-purple-800 rounded-full text-sm">${k}</span>`
                    ).join('');
                } else {
                    keywordsDiv.innerHTML = '<span class="text-gray-500 text-sm">키워드 없음</span>';
                }

                document.getElementById('n2bResult').classList.remove('hidden');
                document.getElementById('matchBtn').disabled = false;
                document.getElementById('matchBtn').classList.remove('bg-gray-400');
                document.getElementById('matchBtn').classList.add('bg-green-500');

            } catch (error) {
                alert('분석 중 오류가 발생했습니다: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function matchPrograms() {
            const apiKey = document.getElementById('apiKey').value;
            const region = document.getElementById('regionSelect').value;

            if (!n2bAnalysis) { alert('먼저 N2B 분석을 수행해주세요.'); return; }

            showLoading(true, '🔄 실시간 정부 API 조회 중...');

            try {
                const response = await fetch(`${API_BASE}/match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiKey, 
                        n2bAnalysis,
                        useRealtime: true  // 실시간 API 사용!
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || '매칭 실패');
                }

                document.getElementById('regionBadge').textContent = `📍 ${region === '전체' ? '전국' : region}`;
                document.getElementById('totalCount').textContent = `📊 총 ${data.total_programs || 0}개 사업 검색`;

                const listDiv = document.getElementById('programList');
                
                // 결과 파싱
                let programs = [];
                if (data.result) {
                    try {
                        const jsonMatch = data.result.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            programs = JSON.parse(jsonMatch[0]);
                        }
                    } catch (e) {
                        console.log('Parse error:', e);
                    }
                }
                
                if (programs.length > 0) {
                    listDiv.innerHTML = programs.map(p => `
                        <div class="bg-white rounded-xl shadow-md p-4 card-hover transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${p.agency || '정부'}</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">매칭 ${p.fit_score || 85}%</span>
                            </div>
                            <h3 class="font-bold text-gray-800">${p.name || '사업명 없음'}</h3>
                            <p class="text-purple-600 text-sm mt-2">💡 ${p.reason || ''}</p>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-center">
                            <p class="text-yellow-700">😅 매칭된 지원사업이 없습니다.</p>
                            <p class="text-gray-600 text-sm mt-2">현재 모집중인 사업이 적을 수 있습니다. (12월은 비수기)</p>
                            <p class="text-gray-500 text-xs mt-2">총 ${data.total_programs || 0}개 사업 검색됨</p>
                        </div>
                    `;
                }

                document.getElementById('matchResult').classList.remove('hidden');

            } catch (error) {
                alert('매칭 중 오류가 발생했습니다: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show, text = '분석 중...') {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('loadingText').textContent = text;
        }
    </script>
</body>
</html>
